# FinOps Chatbot Architecture

## High-Level Overview

The FinOps Chatbot is an AWS-native Retrieval Augmented Generation (RAG) solution designed to deliver FinOps Foundation intelligence to practitioners, executives, and contributors. The system keeps the knowledge base current by continuously ingesting content from approved sources, enforcing guardrails to protect sensitive information, and exposing a contextual chat interface with Bedrock-managed safety features.

```
+-----------------+          +----------------------+        +------------------+
|  Chat Clients   |  HTTPS   |  API & Orchestration |  RAG   |  Bedrock Models  |
| (Chainlit/Meso) +--------->+  (FastAPI on ECS)    +------->+ (Claude / Titan) |
+-----------------+          +----------------------+        +------------------+
         |                             |                               |
         |                +------------v------------+                  |
         |                |   Retrieval Orchestrator|------------------+
         |                +------------+------------+
         |                             |
         |                     +-------v-----------------------------+
         |                     |  Knowledge Platform (Bedrock KB)    |
         |                     |  - S3 Document Lake & Vector Store  |
         |                     |  - Opensearch Metadata Index        |
         |                     +-------+-----------------------------+
         |                             |
         |               +-------------v--------------+
         |               |  Data Ingestion Pipelines  |
         |               |  (Lambda, Step Functions)  |
         |               +-------------+--------------+
         |                             |
         |                 +-----------v-----------+
         |                 |  Source Connectors     |
         |                 |  - FinOps Foundation   |
         |                 |  - Partner Content     |
         |                 |  - Public Reference    |
         |                 +-----------------------+
```

## Components

- **Chat Interface**: Chainlit (or Meso/Gradio) containerized and deployed on AWS ECS with ALB. Uses Cognito for auth and roles that gate data access tiers. Collects conversation context and passes it to the API.
- **API & Orchestration**: FastAPI service running on ECS Fargate. Performs request validation, role-based policy enforcement, orchestrates retrieval and generation, and calls Bedrock Guardrails APIs.
- **Retrieval Orchestrator**: LangChain or LlamaIndex-based orchestration layer. Handles query rewriting, retrieves top-k documents from Bedrock Knowledge Base, enforces document-level ACLs, and performs context compression.
- **Knowledge Platform**:
  - **Document Lake**: S3 buckets partitioned by data sensitivity (public, member-only, internal). Lifecycle policies ensure versioning and archival.
  - **Vector Store**: Bedrock Knowledge Base backed by S3 Vectors for cost efficiency, with Opensearch Serverless for metadata search and filtering.
  - **Metadata Registry**: DynamoDB table tracking document provenance, classification, and guardrail exemptions.
- **Data Ingestion**: Step Functions orchestrate connectors (Lambda-based) that pull from websites, Slack, YouTube transcripts, PDFs, and shared drives. Content is normalized, classified, and enriched before landing in S3.
- **Guardrails Layer**: Bedrock Guardrails backed by custom policies from `config/guardrails.yaml`. Additional Lambda filters scan documents and generated responses for PII, credentials, and embargoed information.
- **Observability & Ops**: CloudWatch for metrics, OpenSearch Dashboards for search analytics, and AWS HealthLake for audit logs. Bedrock Converse API logs stored securely for post-hoc review.

## Data Flow Stages

1. **Ingestion**: Connectors collect raw artifacts, run OCR/transcription if needed, and store them in `s3://finops-chatbot-raw/<source>/<timestamp>/`.
2. **Processing**: AWS Glue jobs normalize formats, extract metadata, perform classification, and emit JSONL records. Document access tier is assigned (public/member/internal/confidential).
3. **Indexing**: Cleaned documents move to curated S3 buckets and are indexed by Bedrock Knowledge Base. Embeddings generated by Titan Embeddings or OpenSearch KNN.
4. **Retrieval**: User query hits the API, which verifies user role and constructs a retrieval pipeline (semantic + keyword + re-ranking). Documents not permitted for the role are filtered before context assembly.
5. **Generation**: API calls Bedrock with Guardrails and prompt templates. The response is post-processed by safety filters (PII, toxicity, hallucination checks).
6. **Feedback & Monitoring**: Interactions logged with metadata, allowing automated evaluation and manual reviews. Users can flag bad responses, feeding into evaluation pipeline.

## Security & Compliance

- AWS KMS encrypts all S3 buckets, DynamoDB tables, and Bedrock logs.
- IAM roles enforce least privilege; data access tiers map to Cognito group claims.
- Guardrail policies ensure no confidential material is exposed to unauthorized users.
- Audit trails stored in AWS CloudTrail and centralized SIEM for compliance.

## Deployment Strategy

- Infrastructure managed with AWS CDK (Python) templates under `infrastructure/`.
- CI/CD via GitHub Actions deploying containers to ECR/ECS and running IaC changesets.
- Separate environments (dev, staging, prod) with isolated S3 buckets and Bedrock KB instances.
- Feature flags and prompt configurations stored in AWS AppConfig for runtime control.

## Open Questions / Next Steps

- Validate cost model for S3 Vectors vs. third-party vector DB.
- Evaluate multi-tenant guardrail requirements for partner-specific content.
- Decide on streaming vs. chunked responses to keep latency low when using slower vector stores.
- Finalize logging retention and redaction strategy to comply with member privacy expectations.
